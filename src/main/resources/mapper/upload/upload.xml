<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.roadscanner.upload">
  
  <!-- 피드백 분기별 그래프 -->
  <select id="quarterlyFeedback" parameterType="FileUploadVO" resultType="FileUploadVO">
    SELECT
        TO_CHAR(u_date, 'Q') AS uDate,
        COUNT(u_1) AS u1,
        COUNT(u_2) AS u2
    FROM
        upload_image
    GROUP BY TO_CHAR(u_date, 'Q')
  </select>
  
  <!-- 피드백 누적 그래프, 표 -->
  <select id="totalFeedback" parameterType="FileUploadVO" resultType="FileUploadVO">
    SELECT
        COUNT(u_1) AS u1,
        COUNT(u_2) AS u2
    FROM
        upload_image
  </select>
  
  <!-- 사진 목록 조회 -->
  <select id="doRetrieve" parameterType="FileUploadVO" resultType="FileUploadVO">
    SELECT A.*, B.*
    FROM(
        SELECT
            TT1.u_url AS uUrl,
            TT1.u_check AS uCheck
        FROM(
            SELECT T1.*
            FROM(
                SELECT *
                FROM upload_image
                WHERE u_div = #{uDiv}
                ORDER BY u_date ASC
            )T1
            <![CDATA[ WHERE ROWNUM <= #{pageSize} * (#{pageNo} - 1) + #{pageSize} ]]>
        )TT1
        <![CDATA[ WHERE rnum >= #{pageSize} * (#{pageNo} - 1) + 1 ]]>
    )A
    CROSS JOIN
    (
        SELECT COUNT(*) AS totalCnt
        FROM board
        WHERE u_div = #{uDiv}
    )B
  </select>
  
  <!-- 사진 상세 조회 -->
  <select id="doSelectOne" parameterType="FileUploadVO" resultType="FileUploadVO">
    SELECT
        u_idx AS uIdx,
        u_id AS id,
        u_div AS uDiv,
        TO_CHAR(u_date, 'YYYY-MM-DD HH24:MI:SS') AS uDate,
        u_name AS uName,
        u_url AS uUrl,
        u_size AS uSize,
        u_check AS uCheck
    FROM
        upload_image
    WHERE
        u_idx = #{uIdx}
  </select>
  
  <!-- 사진 구분, 싫어요 이유, 검토 여부 수정 -->
  <update id="doUpdate" parameterType="FileUploadVO">
	  UPDATE upload_image
		SET
		  u_div   = #{uDiv},
		  u_1     = #{u1},
		  u_2     = #{u2},
		  u_check = #{uCheck}
		WHERE
		  u_idx = #{uIdx}
  </update>
  
  <!-- 사진 삭제 -->
  <delete id="doDelete" parameterType="FileUploadVO">
    DELETE FROM upload_image
    WHERE u_idx = #{uIdx}
  </delete>
  
  <!-- 사진 업로드 -->
  <insert id="doSave" parameterType="FileUploadVO">
    INSERT INTO upload_image (
        u_idx,
        u_id,
        u_div,
        u_date,
        u_name,
        u_url,
        u_size,
        u_check
    ) VALUES (
        #{uIdx},
        #{id},
        10,
        SYSDATE,
        #{uName},
        #{uUrl},
        #{uSize},
        0
    )
  </insert>

</mapper>