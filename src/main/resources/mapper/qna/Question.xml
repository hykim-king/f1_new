<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.roadscanner.dao.qna.QuestionDAO">

    <!-- 오라클 insert 확인 O-->
    <insert id="save">

        INSERT INTO QUESTION (no, category, id, idx, title, content)
        VALUES (QUESTION_SEQ.NEXTVAL, #{category}, #{id}, #{idx}, #{title}, #{content})
    </insert>

<!--    <insert id="save">-->
<!--        INSERT INTO QUESTION (no, category, id, title, content)-->
<!--        VALUES (#{no}, #{category}, #{id}, #{title}, #{content})-->
<!--    </insert>-->

    <!-- no로 질문 조회 오라클 O-->
    <select id="findByNo" resultType="QuestionVO">
        SELECT
            no,
            category,
            views,
            idx,
            id,
            title,
            content,
            create_date AS createDate,
            update_date AS updateDate
--         update_date AS updateDate
        FROM QUESTION
        WHERE no = #{no}
    </select>

    <!-- 모든 질문 조회 -->
    <select id="findAll" resultType="QuestionVO">
        SELECT *
        FROM (
        SELECT a.*, rownum rnum
        FROM (
        SELECT
        no,
        category,
        views,
        idx,
        id,
        title,
        content,
        create_date AS createDate,
        update_date AS updateDate
        FROM QUESTION
        <where>
            <if test="searchCond.searchType == 'title'">
                title LIKE '%' || #{searchCond.keyword} || '%'
            </if>
            <if test="searchCond.searchType == 'content'">
                content LIKE '%' || #{searchCond.keyword} || '%'
            </if>
            <if test="searchCond.searchType == 'both'">
                (title LIKE '%' || #{searchCond.keyword} || '%' OR content LIKE '%' || #{searchCond.keyword} || '%')
            </if>
        </where>
        ORDER BY CASE WHEN category = 10 THEN 1 ELSE 2 END, no DESC
        ) a WHERE rownum &lt;= #{pagination.start} + #{pagination.size}
        ) WHERE rnum &gt; #{pagination.start}
    </select>

    <!-- 질문 업데이트 -->
    <update id="update">
        UPDATE QUESTION
        SET
            category = #{category},
            idx = #{idx},
            title = #{title},
            content = #{content},
            update_date = CURRENT_TIMESTAMP
        WHERE no = #{no}
    </update>

    <!-- 질문 삭제 -->
    <delete id="delete">
        DELETE FROM QUESTION WHERE no = #{no}
    </delete>

    <!-- 페이징 구현 -->
<!--    <select id="findAllWithPaging" resultType="QuestionVO">-->
<!--        SELECT *-->
<!--        FROM (SELECT a.*, rownum rnum-->
<!--              FROM (SELECT-->
<!--                        no,-->
<!--                        category,-->
<!--                        views,-->
<!--                        title,-->
<!--                        id,-->
<!--                        create_date AS createDate,-->
<!--                        update_date AS updateDate-->
<!--                    FROM QUESTION-->
<!--                    ORDER BY CASE WHEN category = 10 THEN 1 ELSE 2 END, no DESC-->
<!--                   ) a WHERE rownum &lt;= #{start} + #{size}-->
<!--             ) WHERE rnum &gt; #{start}-->
<!--    </select>-->

<!--    <select id="countQuestions" resultType="int">-->
<!--        SELECT count(*) FROM question-->
<!--    </select>-->

    <select id="countQuestions" resultType="int">
        SELECT count(*) FROM question
        <where>
            <if test="searchType == 'title'">
                title LIKE '%' || #{keyword} || '%'
            </if>
            <if test="searchType == 'content'">
                content LIKE '%' || #{keyword} || '%'
            </if>
            <if test="searchType == 'both'">
                (title LIKE '%' || #{keyword} || '%' OR content LIKE '%' || #{keyword} || '%')
            </if>
        </where>
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseViews">
        UPDATE QUESTION
        SET views = views + 1
        WHERE no = #{no}
    </update>

    <!-- 답변 등록 시 카테고리 변경 -->
    <update id="updateCategory">
        UPDATE question
        SET category = (
            CASE
                WHEN EXISTS (SELECT 1 FROM answer WHERE question.no = answer.no)
                    THEN 20
                ELSE 30
                END
            )
        WHERE no = #{no}
    </update>

</mapper>
